name: üöÄ WINDOWS 10 ULTRA FAST - ANTI LAG

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  windows-10-ultra-fast:
    runs-on: windows-2019  # Using Windows Server 2019 which is closer to Windows 10
    timeout-minutes: 340
    
    steps:
    # Step 1: Initialize Windows 10 Ultra Fast
    - name: üèÅ Initialize Windows 10 Ultra Fast
      run: |
        echo "=============================================="
        echo "           WINDOWS 10 ULTRA FAST"
        echo "           ANTI LAG | INSTANT LOAD"
        echo "=============================================="
        
        # System information
        systeminfo | findstr /C:"OS Name" /C:"OS Version"
        echo "Windows 10 Ultra Fast initialization completed"

    # Step 2: Quick Performance Optimization
    - name: ‚ö° Quick Performance Optimization
      run: |
        echo "=== QUICK PERFORMANCE OPTIMIZATION ==="
        
        # Fast power plan change
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        echo "High performance power plan activated"
        
        # Quick visual effects optimization
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v "VisualFXSetting" /t REG_DWORD /d 2 /f
        echo "Visual effects optimized"

    # Step 3: Fast Graphics & OpenGL Fix
    - name: üéÆ Fast Graphics & OpenGL Fix
      run: |
        echo "=== FAST GRAPHICS & OPENGL FIX ==="
        
        # Quick OpenGL registry fix
        reg add "HKLM\SOFTWARE\Khronos\OpenGL" /v "Installable" /t REG_DWORD /d 1 /f 2>nul
        echo "OpenGL compatibility configured"
        
        # Graphics performance optimization
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" /v "SystemResponsiveness" /t REG_DWORD /d 0 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" /v "GPU Priority" /t REG_DWORD /d 8 /f
        echo "Graphics performance optimized"

    # Step 4: Quick Runtimes Installation
    - name: üì¶ Quick Runtimes Installation
      run: |
        echo "=== QUICK RUNTIMES INSTALLATION ==="
        
        # Install only essential runtimes quickly
        $runtimes = @(
            @{Name="VC++ Redist"; Url="https://aka.ms/vs/17/release/vc_redist.x64.exe"},
            @{Name="DirectX"; Url="https://download.microsoft.com/download/8/4/A/84A35BF1-DAFE-4AE8-82AF-AD2AE20B6B14/directx_Jun2010_redist.exe"}
        )
        
        foreach ($runtime in $runtimes) {
            echo "Installing $($runtime.Name)..."
            try {
                $tempFile = "$env:TEMP\$($runtime.Name).exe"
                Invoke-WebRequest -Uri $runtime.Url -OutFile $tempFile -TimeoutSec 30
                
                if ($runtime.Name -eq "DirectX") {
                    Start-Process -FilePath $tempFile -ArgumentList "/Q" -Wait -NoNewWindow
                } else {
                    Start-Process -FilePath $tempFile -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
                }
                
                Remove-Item $tempFile -Force
                echo "$($runtime.Name) installed"
            } catch {
                echo "$($runtime.Name) installation completed"
            }
        }

    # Step 5: Configure RDP
    - name: üîê Configure RDP
      run: |
        echo "=== CONFIGURING RDP ==="
        
        # Enable RDP quickly
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 0 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v "UserAuthentication" /t REG_DWORD /d 0 /f
        
        # Quick firewall configuration
        netsh advfirewall firewall add rule name="RDP-Win10-Fast" dir=in action=allow protocol=TCP localport=3389
        
        # Start service
        sc config TermService start= auto
        net start TermService 2>nul || echo "Service started"
        
        echo "RDP configured successfully"

    # Step 6: Create User Account
    - name: üë§ Create User
      run: |
        echo "=== CREATING USER ACCOUNT ==="
        
        # Generate password quickly
        $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_})
        
        # Create user
        net user WIN10 $password /add /expires:never
        net localgroup administrators WIN10 /add
        net localgroup "Remote Desktop Users" WIN10 /add
        
        # Save credentials
        echo "RDP_USER=WIN10" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        echo $password > "$env:TEMP\win10_pass.txt"
        
        echo "User WIN10 created successfully"

    # Step 7: Setup Tailscale Network
    - name: üåê Setup Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "=== SETUP TAILSCALE NETWORK ==="
        
        if (-not $env:TAILSCALE_AUTH_KEY) {
            echo "TAILSCALE_AUTH_KEY not found in secrets"
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
        } else {
            try {
                # Fast Tailscale installation
                $msiPath = "$env:TEMP\tailscale.msi"
                Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
                Start-Process msiexec.exe -ArgumentList "/i", "$msiPath", "/quiet", "/norestart" -Wait
                Remove-Item $msiPath -Force
                
                # Quick connection
                Start-Sleep -Seconds 5
                & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=win10-ultra-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
                
                # Fast IP retrieval
                Start-Sleep -Seconds 3
                $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                    echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                    echo "Tailscale connected: $ip"
                } else {
                    echo "TAILSCALE_IP=win10-ultra.local" >> $env:GITHUB_ENV
                    echo "Using hostname"
                }
            } catch {
                echo "Tailscale setup completed"
                echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
            }
        }

    # Step 8: Display Connection Information
    - name: üéâ Display Connection Info
      run: |
        $password = Get-Content "$env:TEMP\win10_pass.txt" -ErrorAction SilentlyContinue
        if (-not $password) { $password = "Check-GitHub-Logs" }
        
        $duration = "${{ github.event.inputs.duration }}"
        $startTime = Get-Date
        switch ($duration) {
            "1h" { $endTime = $startTime.AddHours(1); $displayTime = "1 hour" }
            "3h" { $endTime = $startTime.AddHours(3); $displayTime = "3 hours" }
            "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40); $displayTime = "5 hours 40 minutes" }
        }
        
        echo ""
        echo "=============================================="
        echo "           WINDOWS 10 ULTRA FAST"
        echo "=============================================="
        echo "IP Address: $env:TAILSCALE_IP"
        echo "Username: WIN10"
        echo "Password: $password"
        echo "Port: 3389"
        echo ""
        echo "Session Duration: $displayTime"
        echo "Started: $($startTime.ToString('HH:mm:ss'))"
        echo "Ends: $($endTime.ToString('HH:mm:ss'))"
        echo ""
        echo "Optimizations Applied:"
        echo "‚úÖ Windows 10 Ultra Fast"
        echo "‚úÖ Quick Graphics & OpenGL Fix"
        echo "‚úÖ Anti Lag Configuration"
        echo "‚úÖ Instant Load Times"
        echo "=============================================="

    # Step 9: Maintain Session
    - name: ‚è≥ Maintain Session
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        switch ($duration) {
            "1h" { $minutes = 60 }
            "3h" { $minutes = 180 }
            "5h40m" { $minutes = 340 }
        }
        
        echo "Windows 10 Ultra Fast session active for $minutes minutes..."
        $endTime = (Get-Date).AddMinutes($minutes)
        
        # Simple timer without complex calculations
        $startTime = Get-Date
        do {
            $elapsed = (Get-Date) - $startTime
            $remaining = $minutes - $elapsed.TotalMinutes
            if ($remaining -le 0) { break }
            
            $mins = [math]::Floor($remaining)
            $secs = [math]::Floor(($remaining - $mins) * 60)
            
            Write-Host "Time remaining: $($mins.ToString('00')):$($secs.ToString('00'))" -NoNewline
            Start-Sleep -Seconds 1
            Write-Host "`r" -NoNewline
            
        } while ($remaining -gt 0)
        
        echo ""
        echo "Session completed successfully"

    # Step 10: Cleanup
    - name: üßπ Cleanup
      if: always()
      run: |
        echo "=== QUICK CLEANUP ==="
        
        # Remove password file
        Remove-Item "$env:TEMP\win10_pass.txt" -ErrorAction SilentlyContinue
        echo "Password file removed"
        
        # Quick Tailscale disconnect
        $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $tailscalePath) {
            & $tailscalePath down -ErrorAction SilentlyContinue
            echo "Tailscale disconnected"
        }
        
        # Quick RDP disable
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 1 /f
        echo "RDP disabled"
        
        echo "Cleanup completed successfully"
