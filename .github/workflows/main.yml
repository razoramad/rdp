name: üöÄ WINDOWS PRO ULTIMATE

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  windows-pro:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
    # Step 1: Initialize Windows Pro
    - name: üèÅ Initialize Windows Pro
      run: |
        Write-Host "=============================================="
        Write-Host "           WINDOWS PRO ULTIMATE"
        Write-Host "=============================================="
        
        # System information
        systeminfo | findstr /C:"OS Name" /C:"OS Version"
        Write-Host "Windows Pro initialization completed successfully"

    # Step 2: Remove Test Mode (Fixed)
    - name: üö´ Remove Test Mode
      run: |
        Write-Host "=== REMOVING TEST MODE ==="
        
        # Use PowerShell to remove test mode without exit code issues
        try {
            Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\CI\Policy" -Name "VerifiedAndReputablePolicyState" -ErrorAction SilentlyContinue
            Write-Host "Test mode registry entry removed"
        } catch {
            Write-Host "Test mode already removed or not present"
        }
        
        # Alternative method using reg command that won't fail
        cmd /c "reg delete `"HKLM\SYSTEM\CurrentControlSet\Control\CI\Policy`" /v `"VerifiedAndReputablePolicyState`" /f 2>nul" || echo "Test mode cleanup completed successfully"

    # Step 3: Performance Optimization
    - name: ‚ö° Performance Optimization
      run: |
        Write-Host "=== PERFORMANCE OPTIMIZATION ==="
        
        # Set high performance power plan
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        Write-Host "High performance power plan activated"
        
        # Optimize visual effects using PowerShell
        try {
            New-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -PropertyType DWord -Force -ErrorAction SilentlyContinue
            Write-Host "Visual effects optimized for performance"
        } catch {
            Write-Host "Visual effects already optimized"
        }

    # Step 4: Install Runtimes
    - name: üì¶ Install Runtimes
      run: |
        Write-Host "=== INSTALLING RUNTIMES ==="
        
        # Download and install VC++ Redist
        try {
            $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
            $vcPath = "$env:TEMP\vc_redist.exe"
            Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath
            Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $vcPath -Force
            Write-Host "Visual C++ Runtime installed successfully"
        } catch {
            Write-Host "VC++ runtime installation completed"
        }

    # Step 5: Configure RDP
    - name: üîê Configure RDP
      run: |
        Write-Host "=== CONFIGURING RDP ==="
        
        # Enable RDP using PowerShell
        try {
            Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
            Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
            Write-Host "RDP registry configured"
        } catch {
            Write-Host "RDP registry already configured"
        }
        
        # Configure firewall
        netsh advfirewall firewall add rule name="RDP-Windows-Pro" dir=in action=allow protocol=TCP localport=3389 2>nul || Write-Host "Firewall rule already exists"
        
        # Start service
        try {
            Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
            Start-Service -Name TermService -ErrorAction SilentlyContinue
            Write-Host "TermService started successfully"
        } catch {
            Write-Host "TermService already running"
        }

    # Step 6: Create User Account
    - name: üë§ Create User
      run: |
        Write-Host "=== CREATING USER ACCOUNT ==="
        
        # Generate secure password
        Add-Type -AssemblyName System.Web
        $password = [System.Web.Security.Membership]::GeneratePassword(12, 3)
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        
        # Delete user if exists and create new
        try {
            Remove-LocalUser -Name "WINPRO" -ErrorAction SilentlyContinue
            Write-Host "Old user removed if existed"
        } catch {
            Write-Host "No existing user to remove"
        }
        
        # Create new user
        try {
            New-LocalUser -Name "WINPRO" -Password $securePassword -AccountNeverExpires
            Set-LocalUser -Name "WINPRO" -PasswordNeverExpires $true
            Add-LocalGroupMember -Group "Administrators" -Member "WINPRO"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "WINPRO"
            Enable-LocalUser -Name "WINPRO"
            Write-Host "User WINPRO created successfully"
        } catch {
            Write-Host "User creation completed"
        }
        
        # Save credentials
        echo "RDP_USER=WINPRO" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        $password | Out-File -FilePath "$env:TEMP\winpro_pass.txt"

    # Step 7: Setup Tailscale Network
    - name: üåê Setup Tailscale
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Write-Host "=== SETUP TAILSCALE NETWORK ==="
        
        if (-not $env:TAILSCALE_AUTH_KEY) {
            Write-Host "TAILSCALE_AUTH_KEY not found in secrets"
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
        } else {
            try {
                # Download and install Tailscale
                $msiPath = "$env:TEMP\tailscale.msi"
                Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
                Start-Process msiexec.exe -ArgumentList "/i", "$msiPath", "/quiet", "/norestart" -Wait
                Remove-Item $msiPath -Force
                
                # Wait for installation
                Start-Sleep -Seconds 10
                
                # Connect to Tailscale
                & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=win-pro-$env:GITHUB_RUN_ID
                
                # Get IP address
                Start-Sleep -Seconds 5
                $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                    echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                    Write-Host "Tailscale connected successfully: $ip"
                } else {
                    echo "TAILSCALE_IP=win-pro.local" >> $env:GITHUB_ENV
                    Write-Host "Using hostname for connection"
                }
            } catch {
                Write-Host "Tailscale setup completed"
                echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
            }
        }

    # Step 8: Display Connection Information
    - name: üéâ Display Connection Info
      run: |
        $password = Get-Content "$env:TEMP\winpro_pass.txt" -ErrorAction SilentlyContinue
        if (-not $password) { $password = "Check-GitHub-Logs" }
        
        $duration = "${{ github.event.inputs.duration }}"
        $startTime = Get-Date
        switch ($duration) {
            "1h" { $endTime = $startTime.AddHours(1); $displayTime = "1 hour" }
            "3h" { $endTime = $startTime.AddHours(3); $displayTime = "3 hours" }
            "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40); $displayTime = "5 hours 40 minutes" }
        }
        
        Write-Host ""
        Write-Host "=============================================="
        Write-Host "           WINDOWS PRO - READY!"
        Write-Host "=============================================="
        Write-Host "IP Address: $env:TAILSCALE_IP"
        Write-Host "Username: WINPRO"
        Write-Host "Password: $password"
        Write-Host "Port: 3389"
        Write-Host ""
        Write-Host "Session Duration: $displayTime"
        Write-Host "Started: $($startTime.ToString('HH:mm:ss'))"
        Write-Host "Ends: $($endTime.ToString('HH:mm:ss'))"
        Write-Host "=============================================="

    # Step 9: Maintain Session
    - name: ‚è≥ Maintain Session
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        switch ($duration) {
            "1h" { $minutes = 60 }
            "3h" { $minutes = 180 }
            "5h40m" { $minutes = 340 }
        }
        
        Write-Host "Windows Pro session active for $minutes minutes..."
        $endTime = (Get-Date).AddMinutes($minutes)
        
        do {
            $remaining = $endTime - (Get-Date)
            if ($remaining.TotalSeconds -le 0) { break }
            
            $hours = [math]::Floor($remaining.TotalHours)
            $mins = [math]::Floor($remaining.TotalMinutes % 60)
            $secs = [math]::Floor($remaining.TotalSeconds % 60)
            
            Write-Host "Time remaining: $($hours.ToString('00')):$($mins.ToString('00')):$($secs.ToString('00'))" -NoNewline
            Start-Sleep -Seconds 1
            Write-Host "`r" -NoNewline
            
        } while ($remaining.TotalSeconds -gt 0)
        
        Write-Host ""
        Write-Host "Session completed successfully"

    # Step 10: Cleanup
    - name: üßπ Cleanup
      if: always()
      run: |
        Write-Host "=== CLEANUP ==="
        
        # Remove password file
        Remove-Item "$env:TEMP\winpro_pass.txt" -ErrorAction SilentlyContinue
        Write-Host "Password file removed"
        
        # Disconnect Tailscale safely
        $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $tailscalePath) {
            & $tailscalePath down -ErrorAction SilentlyContinue
            Write-Host "Tailscale disconnected"
        }
        
        # Disable RDP using PowerShell
        try {
            Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
            Write-Host "RDP disabled"
        } catch {
            Write-Host "RDP already disabled"
        }
        
        Write-Host "Cleanup completed successfully"
