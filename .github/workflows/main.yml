name: ğŸš€ WINDOWS 11 ANTI LAG SUPER FAST - BLUESTACKS READY

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Session Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'
      bluestacks_version:
        description: 'ğŸ“± BlueStacks Version'
        required: false
        default: 'nougat'
        type: choice
        options:
        - 'nougat'
        - 'pie'
        - 'android11'

jobs:
  windows-super-fast:
    runs-on: windows-2022
    timeout-minutes: 340
    
    steps:
    # Step 1: Initialize
    - name: ğŸ Initialize Windows Super Fast
      run: |
        echo "=============================================="
        echo "   WINDOWS 11 ANTI LAG SUPER FAST"
        echo "   BLUESTACKS READY | VT ENABLED"
        echo "=============================================="
        
        # Check system info
        systeminfo | findstr /C:"OS Name" /C:"System Type"
        echo "Initialization completed"

    # Step 2: Enable Virtualization & Features
    - name: ğŸ”§ Enable Virtualization Technology
      run: |
        echo "=== ENABLING VIRTUALIZATION ==="
        
        # Enable Windows features
        Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
        Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -All -NoRestart
        Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform -All -NoRestart
        
        # Disable security features that block BlueStacks
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard" /v "EnableVirtualizationBasedSecurity" /t REG_DWORD /d 0 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard" /v "RequirePlatformSecurityFeatures" /t REG_DWORD /d 0 /f
        
        echo "VT Enabled: Hyper-V, VirtualMachinePlatform, HypervisorPlatform"

    # Step 3: Install Required Dependencies
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "=== INSTALLING DEPENDENCIES ==="
        
        # Disable Windows Defender temporarily
        Set-MpPreference -DisableRealtimeMonitoring $true
        
        # Install VC++ Redist
        $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcPath = "$env:TEMP\vc_redist.exe"
        Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath
        Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
        
        # Install .NET Framework 4.8 if not present
        $netPath = "$env:TEMP\ndp48-web.exe"
        Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/?linkid=2088631" -OutFile $netPath
        Start-Process -FilePath $netPath -ArgumentList "/q", "/norestart" -Wait -NoNewWindow
        
        # Re-enable Defender
        Set-MpPreference -DisableRealtimeMonitoring $false
        
        Remove-Item "$env:TEMP\vc_redist.exe", "$env:TEMP\ndp48-web.exe" -Force -ErrorAction SilentlyContinue
        echo "Dependencies installed"

    # Step 4: Install BlueStacks (Based on Selection)
    - name: ğŸ“± Install BlueStacks
      run: |
        $version = "${{ github.event.inputs.bluestacks_version }}"
        echo "=== INSTALLING BLUESTACKS $($version.ToUpper()) ==="
        
        # Select version
        $url = switch ($version) {
            "nougat" { "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe" }
            "pie" { "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe" }
            "android11" { "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe" }
            default { "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe" }
        }
        
        $installer = "$env:TEMP\BlueStacksInstaller.exe"
        Invoke-WebRequest -Uri $url -OutFile $installer
        
        # Run installer silently
        Start-Process -FilePath $installer -ArgumentList "/silent", "/S" -Wait -NoNewWindow
        
        # Wait for installation
        Start-Sleep -Seconds 30
        
        # Create shortcut on desktop
        $desktop = [Environment]::GetFolderPath("Desktop")
        $wshell = New-Object -ComObject WScript.Shell
        $shortcut = $wshell.CreateShortcut("$desktop\BlueStacks 5.lnk")
        $shortcut.TargetPath = "${env:ProgramFiles}\BlueStacks_nxt\HD-Player.exe"
        $shortcut.Save()
        
        Remove-Item $installer -Force
        echo "BlueStacks $version installed successfully"

    # Step 5: Configure BlueStacks
    - name: âš™ï¸ Configure BlueStacks
      run: |
        echo "=== CONFIGURING BLUESTACKS ==="
        
        # Create config directory
        $configDir = "$env:ProgramData\BlueStacks_nxt"
        if (!(Test-Path $configDir)) {
            New-Item -ItemType Directory -Path $configDir -Force
        }
        
        # BlueStacks configuration
        $config = @"
bst.instance.Nougat64.status=1
bst.instance.Nougat64.launch_without_tray=1
bst.instance.Nougat64.adb_port=5555
bst.feature.rooting=1
bst.instance.Nougat64.cpu_count=4
bst.instance.Nougat64.memory=4096
bst.instance.Nougat64.enable_vulkan=0
bst.instance.Nougat64.graphics_renderer=1
bst.instance.Nougat64.fastboot=1
bst.instance.Nougat64.low_memory_mode=0
bst.feature.auto_start=0
"@
        
        $config | Out-File -FilePath "$configDir\bluestacks.conf" -Encoding ASCII
        echo "BlueStacks configured for optimal performance"

    # Step 6: Setup RDP & User
    - name: ğŸ” Setup Remote Access
      run: |
        echo "=== SETUP REMOTE ACCESS ==="
        
        # Enable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        
        # Create user
        $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%'
        $password = -join ((1..12) | ForEach-Object { $chars[(Get-Random -Minimum 0 -Maximum $chars.Length)] })
        
        $user = "gamer"
        Remove-LocalUser -Name $user -ErrorAction SilentlyContinue
        New-LocalUser -Name $user -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $user
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
        Enable-LocalUser -Name $user
        
        # Save credentials
        echo "RDP_USER=$user" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        echo $password > "$env:TEMP\rdp_password.txt"
        
        # Configure firewall
        netsh advfirewall firewall add rule name="RDP-Port" dir=in action=allow protocol=TCP localport=3389
        
        echo "RDP configured - User: $user, Password saved"

    # Step 7: Setup Tailscale (Optional)
    - name: ğŸŒ Setup Network
      env:
        TAILSCALE_KEY: ${{ secrets.TAILSCALE_KEY }}
      run: |
        echo "=== SETUP NETWORK ==="
        
        if ($env:TAILSCALE_KEY) {
            $msi = "$env:TEMP\tailscale.msi"
            Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msi
            Start-Process msiexec.exe -ArgumentList "/i", "$msi", "/quiet", "/norestart" -Wait
            Remove-Item $msi -Force
            
            Start-Sleep -Seconds 5
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_KEY --hostname=win11-bs-$env:GITHUB_RUN_ID
            
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($ip) {
                echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            } else {
                echo "TAILSCALE_IP=win11-bs-$env:GITHUB_RUN_ID.local" >> $env:GITHUB_ENV
            }
        } else {
            echo "TAILSCALE_IP=No-Tailscale" >> $env:GITHUB_ENV
            echo "Using local RDP only"
        }

    # Step 8: Display Connection Info
    - name: ğŸ“Š Display Info
      run: |
        $pass = Get-Content "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
        if (-not $pass) { $pass = "Generated-in-logs" }
        
        $duration = "${{ github.event.inputs.duration }}"
        $bluestacks = "${{ github.event.inputs.bluestacks_version }}"
        
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘     WINDOWS 11 ANTI LAG SUPER FAST      â•‘"
        echo "â•‘         BLUESTACKS READY - VT ON        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ”— CONNECTION INFO:"
        echo "   IP: $env:TAILSCALE_IP"
        echo "   User: $env:RDP_USER"
        echo "   Pass: $pass"
        echo "   Port: 3389"
        echo ""
        echo "ğŸ“± BLUESTACKS:"
        echo "   Version: $bluestacks"
        echo "   Cores: 4 CPU"
        echo "   RAM: 4GB"
        echo "   VT: ENABLED"
        echo ""
        echo "â±ï¸  SESSION: $duration"
        echo ""
        echo "âœ… READY FOR GAMING!"
        echo "   Desktop shortcut: BlueStacks 5"
        echo "   First boot may take 2-3 minutes"
        echo ""

    # Step 9: Run Session Timer
    - name: â³ Session Timer
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        $minutes = switch ($duration) {
            "1h" { 60 }
            "3h" { 180 }
            default { 340 }
        }
        
        $end = (Get-Date).AddMinutes($minutes)
        echo "Session active for $minutes minutes"
        
        while ((Get-Date) -lt $end) {
            $remaining = $end - (Get-Date)
            $hours = [math]::Floor($remaining.TotalHours)
            $mins = [math]::Floor($remaining.TotalMinutes % 60)
            
            Write-Host "â° Time left: ${hours}h ${mins}m" -ForegroundColor Yellow
            Start-Sleep -Seconds 60
        }
        
        echo "Session completed"

    # Step 10: Cleanup
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "Cleaning up..."
        
        # Remove sensitive files
        Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
        
        # Disable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force
        
        # Tailscale down if installed
        $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $ts) {
            & $ts down
        }
        
        echo "Cleanup completed"
