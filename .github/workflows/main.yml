name: üöÄ WINDOWS 10 ANTI LAG SUPER FAST - BLUESTACKS READY

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  windows-10-super-fast:
    runs-on: windows-2022
    timeout-minutes: 340
    
    steps:
    # Step 1: Initialize Windows 10 Super Fast
    - name: üèÅ Initialize Windows 10 Super Fast
      run: |
        echo "=============================================="
        echo "      WINDOWS 10 ANTI LAG SUPER FAST"
        echo "      BLUESTACKS READY | VT ENABLED"
        echo "=============================================="
        echo "Initializing Windows 10 for BlueStacks compatibility..."

    # Step 2: Enable Virtualization Technology (VT)
    - name: üîß Enable VT (Virtualization Technology)
      run: |
        echo "=== ENABLING VIRTUALIZATION TECHNOLOGY ==="
        
        # Enable Hyper-V and Windows Hypervisor Platform
        Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All -NoRestart
        Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform -All -NoRestart
        
        # Enable Windows Sandbox (helps with virtualization)
        Enable-WindowsOptionalFeature -Online -FeatureName Containers-DisposableClientVM -All -NoRestart
        
        # Enable virtualization in BIOS via registry
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard" /v "EnableVirtualizationBasedSecurity" /t REG_DWORD /d 0 /f
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\DeviceGuard" /v "RequirePlatformSecurityFeatures" /t REG_DWORD /d 0 /f
        
        echo "Virtualization Technology enabled successfully"

    # Step 3: Graphics Compatibility Fix
    - name: üéÆ Graphics Compatibility Fix
      run: |
        echo "=== GRAPHICS COMPATIBILITY FIX ==="
        
        # Enable Windows Basic Display Driver (WDDM 1.0 compatibility)
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" /v "DisableHWAcceleration" /t REG_DWORD /d 0 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows\Dwm" /v "ForceSoftwareD3D" /t REG_DWORD /d 0 /f
        
        # Set OpenGL compatibility mode
        reg add "HKLM\SOFTWARE\Khronos\OpenGL" /v "Disable" /t REG_DWORD /d 0 /f
        reg add "HKLM\SOFTWARE\Khronos\OpenGL" /v "UseBasicRenderer" /t REG_DWORD /d 1 /f
        
        # Disable DPI scaling for better compatibility
        reg add "HKCU\Control Panel\Desktop" /v "Win8DpiScaling" /t REG_DWORD /d 0 /f
        reg add "HKCU\Control Panel\Desktop" /v "LogPixels" /t REG_DWORD /d 96 /f
        
        echo "Graphics compatibility optimized for BlueStacks"

    # Step 4: Install DirectX & VC++ (Required for BlueStacks)
    - name: üì¶ Install DirectX & VC++
      run: |
        echo "=== INSTALLING DIRECTX & VC++ ==="
        
        # Install VC++ Redistributable (required by BlueStacks)
        $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcPath = "$env:TEMP\vc_redist.exe"
        Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath
        Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
        Remove-Item $vcPath -Force
        
        # Install DirectX End-User Runtime
        $dxUrl = "https://download.microsoft.com/download/8/4/A/84A35BF1-DAFE-4AE8-82AF-AD2AE20B6B14/directx_Jun2010_redist.exe"
        $dxPath = "$env:TEMP\directx.exe"
        Invoke-WebRequest -Uri $dxUrl -OutFile $dxPath
        Start-Process -FilePath $dxPath -ArgumentList "/Q" -Wait -NoNewWindow
        Remove-Item $dxPath -Force
        
        echo "DirectX and VC++ installed successfully"

    # Step 5: Install BlueStacks 5 Nougat (Compatible Version)
    - name: üì± Install BlueStacks 5 Nougat
      run: |
        echo "=== INSTALLING BLUESTACKS 5 NOUGAT ==="
        
        # Disable Windows Defender temporarily
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        
        # Download BlueStacks 5 Nougat (compatible version)
        $bsUrl = "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe"
        $bsPath = "$env:TEMP\BlueStacksInstaller.exe"
        
        echo "Downloading BlueStacks 5 Nougat..."
        Invoke-WebRequest -Uri $bsUrl -OutFile $bsPath
        
        echo "Installing BlueStacks (this may take a few minutes)..."
        # Install with silent mode and disable Hyper-V warning
        Start-Process -FilePath $bsPath -ArgumentList "/silent", "/install" -Wait -NoNewWindow
        
        # Wait for installation
        Start-Sleep -Seconds 60
        
        # Re-enable Windows Defender
        Set-MpPreference -DisableRealtimeMonitoring $false
        Set-MpPreference -DisableBehaviorMonitoring $false
        
        Remove-Item $bsPath -Force
        echo "BlueStacks 5 Nougat installed successfully!"

    # Step 6: Configure BlueStacks for Performance
    - name: ‚ö° Configure BlueStacks Performance
      run: |
        echo "=== CONFIGURING BLUESTACKS PERFORMANCE ==="
        
        # Create BlueStacks configuration for better performance
        $bsConfigPath = "$env:ProgramData\BlueStacks_nxt\bluestacks.conf"
        
        # Create configuration directory if it doesn't exist
        if (!(Test-Path "$env:ProgramData\BlueStacks_nxt")) {
            New-Item -ItemType Directory -Path "$env:ProgramData\BlueStacks_nxt" -Force
        }
        
        # Write optimized configuration
        @"
bst.instance.Nougat64.status=1
bst.instance.Nougat64.launch_without_tray=1
bst.instance.Nougat64.adb_port=5555
bst.feature.rooting=1
bst.instance.Nougat64.cpu_count=4
bst.instance.Nougat64.memory=4096
bst.instance.Nougat64.enable_vulkan=0
bst.instance.Nougat64.enable_dedicated_graphics=0
bst.instance.Nougat64.fastboot=1
bst.instance.Nougat64.low_memory_mode=0
"@ | Out-File -FilePath $bsConfigPath -Encoding ASCII
        
        echo "BlueStacks performance configuration applied"

    # Step 7: Configure RDP
    - name: üîê Configure RDP
      run: |
        echo "=== CONFIGURING RDP ==="
        
        # Enable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        
        # Configure firewall
        netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389
        
        # Start Terminal Services
        Set-Service -Name "TermService" -StartupType "Automatic"
        Start-Service -Name "TermService"
        
        echo "RDP configured successfully"

    # Step 8: Create User Account
    - name: üë§ Create User Account
      run: |
        echo "=== CREATING USER ACCOUNT ==="
        
        # Generate secure password
        Add-Type -AssemblyName System.Web
        $password = [System.Web.Security.Membership]::GeneratePassword(12, 2)
        
        # Create user
        $username = "bluestacks"
        New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        Enable-LocalUser -Name $username
        
        # Save credentials
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        echo $password > "$env:TEMP\bluestacks_pass.txt"
        
        echo "User account created successfully"

    # Step 9: Setup Tailscale Network
    - name: üåê Setup Tailscale Network
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "=== SETUP TAILSCALE NETWORK ==="
        
        if (-not $env:TAILSCALE_AUTH_KEY) {
            echo "TAILSCALE_AUTH_KEY not found in secrets"
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
            exit 0
        }
        
        # Install Tailscale
        $msiPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
        Start-Process msiexec.exe -ArgumentList "/i", "$msiPath", "/quiet", "/norestart" -Wait
        Remove-Item $msiPath -Force
        
        # Connect to Tailscale
        Start-Sleep -Seconds 5
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=windows-bs-$env:GITHUB_RUN_ID
        
        # Get IP
        Start-Sleep -Seconds 3
        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            echo "Tailscale connected: $ip"
        } else {
            echo "TAILSCALE_IP=windows-bs-$env:GITHUB_RUN_ID" >> $env:GITHUB_ENV
        }

    # Step 10: Display Connection Information
    - name: üéâ Display Connection Info
      run: |
        $password = Get-Content "$env:TEMP\bluestacks_pass.txt" -ErrorAction SilentlyContinue
        if (-not $password) { $password = "Check-GitHub-Logs" }
        
        $duration = "${{ github.event.inputs.duration }}"
        $startTime = Get-Date
        switch ($duration) {
            "1h" { $endTime = $startTime.AddHours(1); $displayTime = "1 hour" }
            "3h" { $endTime = $startTime.AddHours(3); $displayTime = "3 hours" }
            "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40); $displayTime = "5 hours 40 minutes" }
        }
        
        echo ""
        echo "=============================================="
        echo "      WINDOWS 10 ANTI LAG SUPER FAST"
        echo "=============================================="
        echo "IP Address: $env:TAILSCALE_IP"
        echo "Username: bluestacks"
        echo "Password: $password"
        echo "Port: 3389"
        echo ""
        echo "BLUESTACKS READY FEATURES:"
        echo "‚úÖ Virtualization Technology (VT) Enabled"
        echo "‚úÖ BlueStacks 5 Nougat Installed"
        echo "‚úÖ Graphics Compatibility Fix Applied"
        echo "‚úÖ DirectX & VC++ Runtime Installed"
        echo "‚úÖ 4GB RAM & 4 CPU Cores Allocated"
        echo "‚úÖ Performance Optimized Configuration"
        echo ""
        echo "Session Duration: $displayTime"
        echo "Started: $($startTime.ToString('HH:mm:ss'))"
        echo "Ends: $($endTime.ToString('HH:mm:ss'))"
        echo "=============================================="

    # Step 11: Maintain Session
    - name: ‚è≥ Maintain Session
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        switch ($duration) {
            "1h" { $minutes = 60 }
            "3h" { $minutes = 180 }
            "5h40m" { $minutes = 340 }
        }
        
        echo "Windows 10 Anti Lag session active for $minutes minutes..."
        echo "BlueStacks is ready to use!"
        echo ""
        echo "To start BlueStacks after connecting via RDP:"
        echo "1. Open Start Menu"
        echo "2. Search for 'BlueStacks 5'"
        echo "3. Launch the application"
        echo "4. Wait for Android to boot (first boot may take 2-3 minutes)"
        
        $endTime = (Get-Date).AddMinutes($minutes)
        
        do {
            $remaining = $endTime - (Get-Date)
            if ($remaining.TotalSeconds -le 0) { break }
            
            $hours = [math]::Floor($remaining.TotalHours)
            $mins = [math]::Floor($remaining.TotalMinutes % 60)
            $secs = [math]::Floor($remaining.TotalSeconds % 60)
            
            Write-Host "Time remaining: $($hours.ToString('00')):$($mins.ToString('00')):$($secs.ToString('00'))" -NoNewline
            Start-Sleep -Seconds 1
            Write-Host "`r" -NoNewline
            
        } while ($remaining.TotalSeconds -gt 0)
        
        echo ""
        echo "Session completed successfully"

    # Step 12: Cleanup
    - name: üßπ Cleanup
      if: always()
      run: |
        echo "=== CLEANUP ==="
        
        # Remove password file
        Remove-Item "$env:TEMP\bluestacks_pass.txt" -ErrorAction SilentlyContinue
        
        # Disable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force
        
        # Disconnect Tailscale
        $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $tailscalePath) {
            & $tailscalePath down
        }
        
        echo "Cleanup completed"
