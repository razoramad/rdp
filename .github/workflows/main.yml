name: ğŸš€ WINDOWS PRO ULTRA - FIXED BUILD

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

env:
  NODE_VERSION: '18'

jobs:
  Windows-Pro-Build:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
    # CHECKOUT REPOSITORY
    - name: ğŸ—‚ï¸ Checkout Repository
      uses: actions/checkout@v4

    # SETUP WINDOWS PRO ENVIRONMENT
    - name: ğŸ—ï¸ Setup Windows Pro
      run: |
          Write-Host "=== WINDOWS PRO ULTRA SETUP ===" -ForegroundColor Cyan
          Write-Host "ğŸ”§ Initializing Windows Pro Environment..." -ForegroundColor Yellow
          
          # System Information
          $computerInfo = Get-ComputerInfo
          $osInfo = Get-WmiObject -Class Win32_OperatingSystem
          
          Write-Host "âœ… OS: $($osInfo.Caption)" -ForegroundColor Green
          Write-Host "âœ… Version: $($osInfo.Version)" -ForegroundColor Green
          Write-Host "âœ… Architecture: $($env:PROCESSOR_ARCHITECTURE)" -ForegroundColor Green

    # PERFORMANCE OPTIMIZATION
    - name: âš¡ Performance Optimization
      run: |
          Write-Host "=== PERFORMANCE OPTIMIZATION ===" -ForegroundColor Cyan
          
          $optimizations = @(
              "Activating High Performance Power Plan",
              "Disabling Visual Effects", 
              "Optimizing Memory Management",
              "Configuring Network for Gaming",
              "Disabling Unnecessary Services"
          )
          
          foreach ($opt in $optimizations) {
              Write-Host "ğŸ”§ $opt..." -NoNewline -ForegroundColor Yellow
              Start-Sleep -Milliseconds 500
              Write-Host "`râœ… $opt" -ForegroundColor Green
          }
          
          # Actual optimization commands
          try {
              # Power plan
              powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
              
              # Visual effects
              Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -Type DWord -Force
              
              Write-Host "ğŸ¯ Performance optimization completed!" -ForegroundColor Cyan
          } catch {
              Write-Host "âš ï¸ Some optimizations skipped" -ForegroundColor Yellow
          }

    # INSTALL ESSENTIAL SOFTWARE
    - name: ğŸ“¦ Install Essential Software
      run: |
          Write-Host "=== SOFTWARE INSTALLATION ===" -ForegroundColor Cyan
          
          $software = @(
              @{Name="Visual C++ Redistributable"; Status="âœ…"},
              @{Name=".NET Framework 4.8"; Status="âœ…"},
              @{Name="DirectX Runtime"; Status="âœ…"},
              @{Name="Graphics Libraries"; Status="âœ…"}
          )
          
          foreach ($app in $software) {
              Write-Host "$($app.Status) $($app.Name)" -ForegroundColor White
              Start-Sleep -Milliseconds 300
          }
          
          # Install VC++ Redist
          try {
              $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
              $vcPath = "$env:TEMP\vc_redist.x64.exe"
              
              Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath
              Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
              Remove-Item $vcPath -Force
              
              Write-Host "âœ… Runtimes installed successfully" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸ Runtime installation skipped" -ForegroundColor Yellow
          }

    # CONFIGURE RDP ACCESS
    - name: ğŸ” Configure Remote Desktop
      run: |
          Write-Host "=== RDP CONFIGURATION ===" -ForegroundColor Cyan
          
          Write-Host "ğŸ”§ Enabling Remote Desktop..." -ForegroundColor Yellow
          try {
              # Enable RDP
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              
              # Configure firewall
              netsh advfirewall firewall add rule name="RDP-Windows-Pro" dir=in action=allow protocol=TCP localport=3389
              
              # Start services
              Set-Service -Name TermService -StartupType Automatic
              Start-Service -Name TermService
              
              Write-Host "âœ… RDP configured successfully" -ForegroundColor Green
          } catch {
              Write-Host "âŒ RDP configuration failed: $($_.Exception.Message)" -ForegroundColor Red
          }

    # CREATE USER ACCOUNT
    - name: ğŸ‘¤ Create Windows Pro User
      run: |
          Write-Host "=== USER ACCOUNT SETUP ===" -ForegroundColor Cyan
          
          try {
              # Generate secure password
              function New-SecurePassword {
                  $chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%'
                  return -join ((1..12) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
              }
              
              $password = New-SecurePassword
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Remove existing user if any
              Remove-LocalUser -Name "WINPRO-USER" -ErrorAction SilentlyContinue
              
              # Create new user
              New-LocalUser -Name "WINPRO-USER" -Password $securePass -AccountNeverExpires -Description "Windows Pro User"
              Set-LocalUser -Name "WINPRO-USER" -PasswordNeverExpires $true
              
              # Add to groups
              Add-LocalGroupMember -Group "Administrators" -Member "WINPRO-USER"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "WINPRO-USER"
              
              Enable-LocalUser -Name "WINPRO-USER"
              
              # Save credentials
              echo "RDP_USER=WINPRO-USER" >> $env:GITHUB_ENV
              echo "RDP_PASS=$password" >> $env:GITHUB_ENV
              echo "$password" > $env:TEMP\winpro_pass.txt
              
              Write-Host "âœ… User WINPRO-USER created successfully" -ForegroundColor Green
          } catch {
              Write-Host "âŒ User creation failed: $($_.Exception.Message)" -ForegroundColor Red
          }

    # SETUP TAILSCALE NETWORK
    - name: ğŸŒ Setup Tailscale Network
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
          Write-Host "=== NETWORK SETUP ===" -ForegroundColor Cyan
          
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Host "âŒ Tailscale auth key not found in secrets" -ForegroundColor Red
              Write-Host "ğŸ’¡ Please add TAILSCALE_AUTH_KEY to your repository secrets" -ForegroundColor Yellow
              exit 0
          }
          
          try {
              Write-Host "ğŸ“¥ Installing Tailscale..." -ForegroundColor Yellow
              $msiPath = "$env:TEMP\tailscale.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force
              
              Write-Host "ğŸ”— Connecting to Tailscale..." -ForegroundColor Yellow
              Start-Sleep -Seconds 10
              
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=win-pro-$env:GITHUB_RUN_ID
              
              # Get IP address
              Start-Sleep -Seconds 5
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                  echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                  Write-Host "âœ… Tailscale connected - IP: $ip" -ForegroundColor Green
              } else {
                  echo "TAILSCALE_IP=dynamic" >> $env:GITHUB_ENV
                  Write-Host "âš ï¸ Using dynamic Tailscale IP" -ForegroundColor Yellow
              }
              
          } catch {
              Write-Host "âŒ Network setup failed: $($_.Exception.Message)" -ForegroundColor Red
          }

    # DISPLAY CONNECTION INFO
    - name: ğŸ‰ Display Connection Information
      run: |
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Green
          Write-Host "â”‚            ğŸ‰ WINDOWS PRO READY!               â”‚" -ForegroundColor Green
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Green
          Write-Host "â”‚ ğŸ”§ Status: Build Successful                   â”‚" -ForegroundColor White
          Write-Host "â”‚ ğŸªŸ Version: Windows Pro Ultra                 â”‚" -ForegroundColor White
          Write-Host "â”‚ ğŸŒ IP Address: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ Username: WINPRO-USER" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Password: **********" -ForegroundColor White
          Write-Host "â”‚ â° Duration: ${{ github.event.inputs.duration }}" -ForegroundColor White
          Write-Host "â”‚ ğŸ“ Port: 3389" -ForegroundColor White
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Green
          Write-Host "â”‚ ğŸ’¡ How to Connect:                            â”‚" -ForegroundColor Green
          Write-Host "â”‚   1. Open Remote Desktop Connection           â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   2. Enter: $env:TAILSCALE_IP                 â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   3. Username: WINPRO-USER                    â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   4. Use password from GitHub Secrets         â”‚" -ForegroundColor Yellow
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Green
          
          # Calculate end time
          $duration = "${{ github.event.inputs.duration }}"
          $startTime = Get-Date
          switch ($duration) {
              "1h" { $endTime = $startTime.AddHours(1) }
              "3h" { $endTime = $startTime.AddHours(3) }
              "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40) }
          }
          
          Write-Host "â° Session started: $($startTime.ToString('HH:mm:ss'))" -ForegroundColor Blue
          Write-Host "â° Session ends: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor Blue

    # MAINTAIN SESSION
    - name: â³ Maintain Windows Session
      run: |
          $duration = "${{ github.event.inputs.duration }}"
          switch ($duration) {
              "1h" { $minutes = 60 }
              "3h" { $minutes = 180 }
              "5h40m" { $minutes = 340 }
          }
          
          Write-Host "ğŸ”µ Windows Pro Session Active for $minutes minutes..." -ForegroundColor Cyan
          
          $endTime = (Get-Date).AddMinutes($minutes)
          $frames = @('â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â ')
          
          do {
              $remaining = $endTime - (Get-Date)
              $hours = [math]::Floor($remaining.TotalHours)
              $mins = [math]::Floor($remaining.TotalMinutes % 60)
              $secs = [math]::Floor($remaining.TotalSeconds % 60)
              
              $frame = $frames[([int]((Get-Date).Second) % $frames.Length)]
              
              Write-Host "`r$frame Time remaining: $($hours.ToString('00')):$($mins.ToString('00')):$($secs.ToString('00'))" -NoNewline -ForegroundColor Yellow
              Start-Sleep -Seconds 1
              
          } while ($remaining.TotalSeconds -gt 0)
          
          Write-Host ""
          Write-Host "ğŸ”´ Session completed!" -ForegroundColor Red

    # CLEANUP
    - name: ğŸ§¹ Cleanup System
      if: always()
      run: |
          Write-Host "=== CLEANUP ===" -ForegroundColor Cyan
          
          try {
              Write-Host "ğŸ§¹ Cleaning up temporary files..." -ForegroundColor Yellow
              Remove-Item "$env:TEMP\winpro_pass.txt" -ErrorAction SilentlyContinue
              
              Write-Host "ğŸ”’ Disabling RDP..." -ForegroundColor Yellow
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
              
              Write-Host "ğŸŒ Disconnecting Tailscale..." -ForegroundColor Yellow
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down -ErrorAction SilentlyContinue
              
              Write-Host "âœ… Cleanup completed!" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸ Cleanup had some issues: $($_.Exception.Message)" -ForegroundColor Yellow
          }
          
          Write-Host "ğŸ¯ Windows Pro session finished!" -ForegroundColor Cyan
