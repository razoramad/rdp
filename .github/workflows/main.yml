name: ğŸš€ RAZZDEVS - WINDOWS GAMING READY

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Session Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'
      game:
        description: 'ğŸ® Game to Install'
        required: false
        default: 'none'
        type: choice
        options:
        - 'none'
        - 'freefire'
        - 'mlbb'
        - 'pubgm'
        - 'codm'

jobs:
  razzdevs-gaming:
    runs-on: windows-latest
    timeout-minutes: 400
    
    steps:
    # Step 1: Initialize RazzDevs
    - name: ğŸ Initialize RazzDevs
      run: |
        echo "=============================================="
        echo "           RAZZDEVS GAMING READY"
        echo "     Windows Optimized for BlueStacks"
        echo "=============================================="
        
        # Check system
        systeminfo | findstr /C:"OS Name" /C:"Total Physical Memory"
        echo "System check completed"

    # Step 2: Fix Common Errors
    - name: ğŸ”§ Fix Common Errors
      run: |
        echo "=== FIXING COMMON ERRORS ==="
        
        # Fix permission issues
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        
        # Fix network issues
        netsh winsock reset
        netsh int ip reset
        
        # Fix graphics registry errors
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\OpenGL" /v "Version" /t REG_SZ /d "1.0" /f 2>nul
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer" /v "EnableAutoTray" /t REG_DWORD /d 0 /f
        
        # Disable Windows Defender temporarily
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        
        echo "Common errors fixed"

    # Step 3: Install Dependencies
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "=== INSTALLING DEPENDENCIES ==="
        
        # Create temp directory
        New-Item -ItemType Directory -Path "$env:TEMP\razzdevs" -Force
        
        # Install VC++ Redist
        $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcPath = "$env:TEMP\razzdevs\vc_redist.exe"
        try {
            Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath -TimeoutSec 30
            Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
            echo "VC++ installed"
        } catch {
            echo "VC++ install skipped"
        }
        
        # Install .NET Framework
        $netUrl = "https://download.visualstudio.microsoft.com/download/pr/2d6bb6b2-226a-4baa-bdec-798822606ff1/9b7b8746971ed51a1770ae4293618187/ndp48-web.exe"
        $netPath = "$env:TEMP\razzdevs\dotnet.exe"
        try {
            Invoke-WebRequest -Uri $netUrl -OutFile $netPath -TimeoutSec 30
            Start-Process -FilePath $netPath -ArgumentList "/q", "/norestart" -Wait -NoNewWindow
            echo ".NET installed"
        } catch {
            echo ".NET install skipped"
        }
        
        echo "Dependencies installation completed"

    # Step 4: Install BlueStacks 5
    - name: ğŸ“± Install BlueStacks 5
      run: |
        echo "=== INSTALLING BLUESTACKS 5 ==="
        
        # Download BlueStacks installer
        $bsUrl = "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe"
        $bsPath = "$env:TEMP\razzdevs\bluestacks.exe"
        
        echo "Downloading BlueStacks 5..."
        Invoke-WebRequest -Uri $bsUrl -OutFile $bsPath -TimeoutSec 60
        
        echo "Installing BlueStacks (please wait)..."
        # Install with minimal UI
        $process = Start-Process -FilePath $bsPath -ArgumentList "/S" -PassThru -NoNewWindow
        $process.WaitForExit(300000) # Wait 5 minutes
        
        # Wait additional time for installation
        Start-Sleep -Seconds 60
        
        # Check if installation succeeded
        if (Test-Path "${env:ProgramFiles}\BlueStacks_nxt\HD-Player.exe") {
            echo "âœ… BlueStacks installed successfully!"
        } else {
            echo "âš ï¸ BlueStacks installation may have issues"
        }
        
        # Cleanup
        Remove-Item $bsPath -Force -ErrorAction SilentlyContinue

    # Step 5: Configure BlueStacks
    - name: âš™ï¸ Configure BlueStacks
      run: |
        echo "=== CONFIGURING BLUESTACKS ==="
        
        # Create BlueStacks configuration
        $configDir = "$env:ProgramData\BlueStacks_nxt"
        if (!(Test-Path $configDir)) {
            New-Item -ItemType Directory -Path $configDir -Force
        }
        
        # Write optimized configuration
        $configContent = @"
bst.instance.Nougat64.status=1
bst.instance.Nougat64.launch_without_tray=1
bst.instance.Nougat64.adb_port=5555
bst.feature.rooting=0
bst.instance.Nougat64.cpu_count=4
bst.instance.Nougat64.memory=3072
bst.instance.Nougat64.enable_vulkan=0
bst.instance.Nougat64.graphics_renderer=1
bst.instance.Nougat64.fastboot=1
bst.instance.Nougat64.low_memory_mode=0
bst.feature.auto_start=0
bst.feature.online_content=0
bst.feature.notifications=0
bst.feature.help=0
"@
        
        $configContent | Out-File -FilePath "$configDir\bluestacks.conf" -Encoding ASCII
        
        # Create desktop shortcut
        $desktop = [Environment]::GetFolderPath("Desktop")
        $shortcutPath = "$desktop\BlueStacks 5.lnk"
        $targetPath = "${env:ProgramFiles}\BlueStacks_nxt\HD-Player.exe"
        
        if (Test-Path $targetPath) {
            $WshShell = New-Object -ComObject WScript.Shell
            $Shortcut = $WshShell.CreateShortcut($shortcutPath)
            $Shortcut.TargetPath = $targetPath
            $Shortcut.WorkingDirectory = "${env:ProgramFiles}\BlueStacks_nxt"
            $Shortcut.Save()
            echo "Desktop shortcut created"
        }
        
        echo "BlueStacks configuration completed"

    # Step 6: Install Games (Based on Selection)
    - name: ğŸ® Install Games
      run: |
        $game = "${{ github.event.inputs.game }}"
        echo "=== INSTALLING GAME: $game ==="
        
        if ($game -eq "none") {
            echo "No game selected for installation"
            echo "GAME_STATUS=No game selected" >> $env:GITHUB_ENV
            exit 0
        }
        
        # Game APK URLs
        $gameUrls = @{
            "freefire" = "https://d.apkpure.com/b/APK/com.dts.freefireth?version=latest"
            "mlbb" = "https://d.apkpure.com/b/APK/com.mobile.legends?version=latest"
            "pubgm" = "https://d.apkpure.com/b/APK/com.tencent.ig?version=latest"
            "codm" = "https://d.apkpure.com/b/APK/com.activision.callofduty.shooter?version=latest"
        }
        
        if ($gameUrls.ContainsKey($game)) {
            $apkPath = "$env:TEMP\razzdevs\game.apk"
            
            try {
                # Download APK
                echo "Downloading $game..."
                Invoke-WebRequest -Uri $gameUrls[$game] -OutFile $apkPath -TimeoutSec 120
                
                echo "Game downloaded. Note: Manual installation required in BlueStacks."
                echo "After connecting via RDP:"
                echo "1. Open BlueStacks"
                echo "2. Go to 'Install APK' button"
                echo "3. Select the APK file from $apkPath"
                
                echo "GAME_STATUS=Downloaded - Manual install required" >> $env:GITHUB_ENV
                echo "GAME_APK_PATH=$apkPath" >> $env:GITHUB_ENV
                
            } catch {
                echo "Failed to download game. Can be installed manually from Play Store."
                echo "GAME_STATUS=Download failed - Use Play Store" >> $env:GITHUB_ENV
            }
        } else {
            echo "Invalid game selection"
            echo "GAME_STATUS=Invalid selection" >> $env:GITHUB_ENV
        }

    # Step 7: Setup RDP Access
    - name: ğŸ” Setup RDP Access
      run: |
        echo "=== SETUP RDP ACCESS ==="
        
        # Create razzdevs user
        $username = "razzdevs"
        $password = "RazzDevs@2024!"  # Simple password for easy access
        
        # Remove if exists
        Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
        
        # Create user
        New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        Enable-LocalUser -Name $username
        
        echo "User '$username' created"
        
        # Enable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        
        # Configure firewall
        netsh advfirewall firewall add rule name="RazzDevs-RDP" dir=in action=allow protocol=TCP localport=3389
        
        # Start service
        Set-Service -Name "TermService" -StartupType "Automatic"
        Start-Service -Name "TermService" -ErrorAction SilentlyContinue
        
        # Save credentials
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        echo "RDP_PORT=3389" >> $env:GITHUB_ENV
        
        echo "RDP configured successfully"

    # Step 8: Performance Optimization
    - name: âš¡ Performance Optimization
      run: |
        echo "=== PERFORMANCE OPTIMIZATION ==="
        
        # Set high performance power plan
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # Optimize visual effects
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v "VisualFXSetting" /t REG_DWORD /d 2 /f
        
        # Disable animations
        reg add "HKCU\Control Panel\Desktop" /v "UserPreferencesMask" /t REG_BINARY /d "9032078010000000" /f
        
        # Game mode registry tweaks
        reg add "HKLM\SOFTWARE\Microsoft\PolicyManager\current\device\GraphicsDrivers" /v "HwSchMode" /t REG_DWORD /d 2 /f 2>nul
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" /v "SystemResponsiveness" /t REG_DWORD /d 0 /f
        
        # Re-enable Windows Defender
        Set-MpPreference -DisableRealtimeMonitoring $false
        Set-MpPreference -DisableBehaviorMonitoring $false
        
        echo "Performance optimization completed"

    # Step 9: Display Connection Info
    - name: ğŸ“Š Display Connection Info
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        $game = "${{ github.event.inputs.game }}"
        
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘            RAZZDEVS GAMING READY            â•‘"
        echo "â•‘         Windows + BlueStacks 5              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ”— RDP CONNECTION:"
        echo "   Username: $env:RDP_USER"
        echo "   Password: $env:RDP_PASS"
        echo "   Port: $env:RDP_PORT"
        echo ""
        echo "ğŸ® GAMING SETUP:"
        echo "   BlueStacks 5: Installed (Desktop shortcut)"
        echo "   Selected Game: $game"
        echo "   Game Status: $env:GAME_STATUS"
        echo ""
        echo "âš¡ PERFORMANCE:"
        echo "   CPU Cores: 4 allocated to BlueStacks"
        echo "   RAM: 3GB allocated to BlueStacks"
        echo "   Graphics: Performance mode enabled"
        echo ""
        echo "â±ï¸  SESSION DURATION: $duration"
        echo ""
        echo "ğŸ“ NOTES:"
        echo "   1. Connect via Windows RDP client"
        echo "   2. Open BlueStacks 5 from desktop"
        echo "   3. Game APK available at: $env:GAME_APK_PATH"
        echo "   4. First BlueStacks boot may take 2-3 minutes"
        echo ""
        echo "âœ… READY FOR GAMING!"
        echo ""

    # Step 10: Keep Session Alive
    - name: â³ Keep Session Alive
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        
        # Calculate seconds
        switch ($duration) {
            "1h" { $totalSeconds = 3600 }
            "3h" { $totalSeconds = 10800 }
            default { $totalSeconds = 20400 } # 5h40m
        }
        
        echo "Session will run for $duration ($totalSeconds seconds)"
        echo "Press Ctrl+C in runner logs to stop early"
        
        $startTime = Get-Date
        $endTime = $startTime.AddSeconds($totalSeconds)
        
        while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $hours = [math]::Floor($remaining.TotalHours)
            $minutes = [math]::Floor($remaining.TotalMinutes % 60)
            $seconds = [math]::Floor($remaining.TotalSeconds % 60)
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Time remaining: ${hours}h ${minutes}m ${seconds}s"
            Start-Sleep -Seconds 60
        }
        
        echo "Session completed at $(Get-Date -Format 'HH:mm:ss')"

    # Step 11: Cleanup
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "=== CLEANUP ==="
        
        # Disable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force
        
        # Remove temp files
        Remove-Item "$env:TEMP\razzdevs" -Recurse -Force -ErrorAction SilentlyContinue
        
        # Stop BlueStacks if running
        Get-Process -Name "HD-Player" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
        
        echo "Cleanup completed"
