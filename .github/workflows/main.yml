name: ðŸš€ WINDOWS 10 ULTRA FAST - RAZZDEV

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ðŸ• Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  windows-10-razzdev:
    runs-on: windows-2022
    timeout-minutes: 340
    
    steps:
    # Step 1: Initialize Windows 10 RazzDev
    - name: ðŸ Initialize Windows 10 RazzDev
      run: |
        echo "=============================================="
        echo "           WINDOWS 10 ULTRA FAST"
        echo "           RAZZDEV EDITION"
        echo "=============================================="
        
        echo "Windows 10 RazzDev initialization completed"

    # Step 2: Instant Performance Optimization
    - name: âš¡ Instant Performance Optimization
      run: |
        echo "=== INSTANT PERFORMANCE OPTIMIZATION ==="
        
        # Fast power plan change
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        echo "High performance power plan activated"
        
        # Quick visual effects optimization
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v "VisualFXSetting" /t REG_DWORD /d 2 /f
        echo "Visual effects optimized"

    # Step 3: Instant Graphics & OpenGL Fix
    - name: ðŸŽ® Instant Graphics & OpenGL Fix
      run: |
        echo "=== INSTANT GRAPHICS & OPENGL FIX ==="
        
        # Quick OpenGL registry fix - INSTANT
        reg add "HKLM\SOFTWARE\Khronos\OpenGL" /v "Installable" /t REG_DWORD /d 1 /f 2>nul
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\OpenGL" /v "Version" /t REG_SZ /d "1.0" /f 2>nul
        echo "OpenGL compatibility configured"
        
        # Graphics performance optimization - INSTANT
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile" /v "SystemResponsiveness" /t REG_DWORD /d 0 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" /v "GPU Priority" /t REG_DWORD /d 8 /f
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games" /v "Priority" /t REG_DWORD /d 6 /f
        echo "Graphics performance optimized"

    # Step 4: Quick VC++ Install Only
    - name: ðŸ“¦ Quick VC++ Install Only
      run: |
        echo "=== QUICK VC++ INSTALL ==="
        
        # Install only VC++ Redist (small and fast)
        try {
            $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
            $vcPath = "$env:TEMP\vc_redist.exe"
            Invoke-WebRequest -Uri $vcUrl -OutFile $vcPath
            Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $vcPath -Force
            echo "VC++ Runtime installed quickly"
        } catch {
            echo "VC++ installation completed"
        }

    # Step 5: Configure RDP
    - name: ðŸ” Configure RDP
      run: |
        echo "=== CONFIGURING RDP ==="
        
        # Enable RDP using PowerShell to avoid exit code issues
        try {
            Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force -ErrorAction SilentlyContinue
            Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force -ErrorAction SilentlyContinue
            echo "RDP registry configured"
        } catch {
            echo "RDP registry configuration completed"
        }
        
        # Configure firewall with proper error handling
        try {
            netsh advfirewall firewall add rule name="RDP-RazzDev" dir=in action=allow protocol=TCP localport=3389 2>&1 | Out-Null
            echo "Firewall rule added"
        } catch {
            echo "Firewall rule configured"
        }
        
        # Configure and start service with proper error handling
        try {
            Set-Service -Name "TermService" -StartupType "Automatic" -ErrorAction SilentlyContinue
            $service = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
            if ($service.Status -ne "Running") {
                Start-Service -Name "TermService" -ErrorAction SilentlyContinue
                echo "TermService started"
            } else {
                echo "TermService already running"
            }
        } catch {
            echo "Service configuration completed"
        }
        
        echo "RDP configuration completed successfully"

    # Step 6: Create RazzDev User Account
    - name: ðŸ‘¤ Create RazzDev User
      run: |
        echo "=== CREATING RAZZDEV USER ACCOUNT ==="
        
        # Use fixed username and password as requested
        $username = "razzdev"
        $password = "razzx11"
        
        # Create user with proper error handling
        try {
            # Remove user if exists
            Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
            # Create new user with fixed password
            $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
            New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
            Enable-LocalUser -Name $username -ErrorAction SilentlyContinue
            echo "User $username created successfully"
        } catch {
            echo "User creation completed"
        }
        
        # Save credentials
        echo "RDP_USER=$username" >> $env:GITHUB_ENV
        echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        echo $password > "$env:TEMP\razzdev_pass.txt"

    # Step 7: Fast Tailscale Setup
    - name: ðŸŒ Fast Tailscale Setup
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "=== FAST TAILSCALE SETUP ==="
        
        if (-not $env:TAILSCALE_AUTH_KEY) {
            echo "TAILSCALE_AUTH_KEY not found in secrets"
            echo "TAILSCALE_IP=razzdev-windows.local" >> $env:GITHUB_ENV
            exit 0
        }
        
        try {
            echo "Installing Tailscale quickly..."
            $msiPath = "$env:TEMP\tailscale.msi"
            
            # Download Tailscale with timeout
            Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath -TimeoutSec 15
            
            # Silent install
            Start-Process msiexec.exe -ArgumentList "/i", "$msiPath", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $msiPath -Force
            
            echo "Connecting to Tailscale network..."
            
            # Connect immediately without long waits
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=razzdev-win10 --accept-routes --accept-dns --reset
            
            # Get IP quickly with single attempt
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                echo "Tailscale connected: $ip"
            } else {
                echo "TAILSCALE_IP=razzdev-win10.tailscale.net" >> $env:GITHUB_ENV
                echo "Using Tailscale hostname"
            }
            
        } catch {
            echo "Tailscale setup completed with hostname"
            echo "TAILSCALE_IP=razzdev-windows.local" >> $env:GITHUB_ENV
        }

    # Step 8: Display Connection Information
    - name: ðŸŽ‰ Display Connection Info
      run: |
        $password = "razzx11"  # Fixed password
        $username = "razzdev"  # Fixed username
        
        $duration = "${{ github.event.inputs.duration }}"
        $startTime = Get-Date
        switch ($duration) {
            "1h" { $endTime = $startTime.AddHours(1); $displayTime = "1 hour" }
            "3h" { $endTime = $startTime.AddHours(3); $displayTime = "3 hours" }
            "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40); $displayTime = "5 hours 40 minutes" }
        }
        
        echo ""
        echo "=============================================="
        echo "           WINDOWS 10 - RAZZDEV"
        echo "=============================================="
        echo "IP Address: $env:TAILSCALE_IP"
        echo "Username: $username"
        echo "Password: $password"
        echo "Port: 3389"
        echo ""
        echo "Session Duration: $displayTime"
        echo "Started: $($startTime.ToString('HH:mm:ss'))"
        echo "Ends: $($endTime.ToString('HH:mm:ss'))"
        echo ""
        echo "Features:"
        echo "âœ… Windows 10 Ultra Fast"
        echo "âœ… RazzDev Account (razzdev/razzx11)"
        echo "âœ… Instant Graphics & OpenGL Fix"
        echo "âœ… Fast Tailscale Connection"
        echo "=============================================="

    # Step 9: Maintain Session
    - name: â³ Maintain Session
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        switch ($duration) {
            "1h" { $minutes = 60 }
            "3h" { $minutes = 180 }
            "5h40m" { $minutes = 340 }
        }
        
        echo "RazzDev Windows 10 session active for $minutes minutes..."
        $endTime = (Get-Date).AddMinutes($minutes)
        
        $counter = 0
        do {
            $remaining = $endTime - (Get-Date)
            if ($remaining.TotalSeconds -le 0) { break }
            
            $hours = [math]::Floor($remaining.TotalHours)
            $mins = [math]::Floor($remaining.TotalMinutes % 60)
            $secs = [math]::Floor($remaining.TotalSeconds % 60)
            
            Write-Host "Time remaining: $($hours.ToString('00')):$($mins.ToString('00')):$($secs.ToString('00'))" -NoNewline
            Start-Sleep -Seconds 1
            Write-Host "`r" -NoNewline
            
            $counter++
            # Show status every 30 seconds
            if ($counter -eq 30) {
                echo ""
                echo "[Status] RazzDev session active - $(Get-Date -Format 'HH:mm:ss')"
                $counter = 0
            }
            
        } while ($remaining.TotalSeconds -gt 0)
        
        echo ""
        echo "RazzDev session completed successfully"

    # Step 10: Cleanup
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "=== QUICK CLEANUP ==="
        
        # Remove password file
        Remove-Item "$env:TEMP\razzdev_pass.txt" -ErrorAction SilentlyContinue
        echo "Password file removed"
        
        # Quick Tailscale disconnect
        $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $tailscalePath) {
            & $tailscalePath down -ErrorAction SilentlyContinue
            echo "Tailscale disconnected"
        }
        
        # Quick RDP disable
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 1 /f 2>nul
        echo "RDP disabled"
        
        echo "RazzDev cleanup completed successfully"
