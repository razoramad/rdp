name: ğŸš€ RAZZDEVS WINDOWS GAMING READY

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  windows-gaming:
    runs-on: windows-latest  # Gunakan windows-latest untuk menghindari error
    timeout-minutes: 340
    
    steps:
    # Step 1: Initialize Windows
    - name: ğŸ Initialize Windows Gaming
      run: |
        echo "=============================================="
        echo "           RAZZDEVS WINDOWS GAMING"
        echo "        BLUESTACKS NOUGAT | ANTI LAG"
        echo "=============================================="

    # Step 2: Fix Graphics Compatibility Issues
    - name: ğŸ”§ Fix Graphics Compatibility
      run: |
        echo "=== FIXING GRAPHICS COMPATIBILITY ==="
        
        # Disable Windows Defender temporarily
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        
        # Fix OpenGL compatibility
        reg add "HKLM\SOFTWARE\Khronos\OpenGL" /v "Disable" /t REG_DWORD /d 0 /f 2>nul
        reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\OpenGL" /v "Version" /t REG_SZ /d "1.0" /f 2>nul
        
        # Enable basic graphics renderer (fix untuk BlueStacks error)
        reg add "HKCU\Software\Microsoft\Windows\Dwm" /v "ForceSoftwareD3D" /t REG_DWORD /d 1 /f 2>nul
        reg add "HKLM\SYSTEM\CurrentControlSet\Control\GraphicsDrivers" /v "TdrLevel" /t REG_DWORD /d 0 /f 2>nul
        
        # Disable DPI scaling issues
        reg add "HKCU\Control Panel\Desktop" /v "Win8DpiScaling" /t REG_DWORD /d 0 /f
        reg add "HKCU\Control Panel\Desktop" /v "LogPixels" /t REG_DWORD /d 96 /f
        
        echo "Graphics compatibility fixes applied"

    # Step 3: Install VC++ and Dependencies
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "=== INSTALLING DEPENDENCIES ==="
        
        # Install VC++ Redistributable
        $vcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcPath = "$env:TEMP\vc_redist.exe"
        try {
            (New-Object System.Net.WebClient).DownloadFile($vcUrl, $vcPath)
            Start-Process -FilePath $vcPath -ArgumentList "/install", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $vcPath -Force
            echo "VC++ Runtime installed"
        } catch {
            echo "VC++ install completed"
        }

    # Step 4: Install BlueStacks 5 Nougat (FIXED VERSION)
    - name: ğŸ“± Install BlueStacks 5 Nougat
      run: |
        echo "=== INSTALLING BLUESTACKS 5 NOUGAT ==="
        echo "Downloading BlueStacks 5 Nougat (Compatible Version)..."
        
        # Download BlueStacks 5 Nougat installer
        $bsUrl = "https://cdn3.bluestacks.com/downloads/windows/nxt/5.20.0.1043/BlueStacksMicroInstaller_5.20.0.1043_native.exe"
        $bsPath = "$env:TEMP\BlueStacksNougat.exe"
        
        # Use multiple download methods for reliability
        try {
            (New-Object System.Net.WebClient).DownloadFile($bsUrl, $bsPath)
            echo "Download successful"
        } catch {
            # Fallback download method
            Invoke-WebRequest -Uri $bsUrl -OutFile $bsPath -UseBasicParsing
            echo "Download completed with fallback method"
        }
        
        # Install BlueStacks silently
        echo "Installing BlueStacks 5 Nougat (please wait 2-3 minutes)..."
        $installProcess = Start-Process -FilePath $bsPath -ArgumentList "/S" -PassThru -NoNewWindow
        $installProcess.WaitForExit(180000) # Wait 3 minutes
        
        # Wait for installation to complete
        Start-Sleep -Seconds 30
        
        # Create desktop shortcut
        $desktopPath = [Environment]::GetFolderPath("Desktop")
        $shortcutPath = "$desktopPath\BlueStacks 5 Nougat.lnk"
        $targetPath = "${env:ProgramFiles}\BlueStacks_nxt\HD-Player.exe"
        
        if (Test-Path $targetPath) {
            $shell = New-Object -ComObject WScript.Shell
            $shortcut = $shell.CreateShortcut($shortcutPath)
            $shortcut.TargetPath = $targetPath
            $shortcut.WorkingDirectory = "${env:ProgramFiles}\BlueStacks_nxt"
            $shortcut.Save()
            echo "âœ… BlueStacks 5 Nougat installed successfully!"
        } else {
            echo "âš ï¸ BlueStacks installation may need manual setup"
        }
        
        # Cleanup
        Remove-Item $bsPath -Force -ErrorAction SilentlyContinue

    # Step 5: Configure BlueStacks Performance
    - name: âš™ï¸ Configure BlueStacks
      run: |
        echo "=== CONFIGURING BLUESTACKS PERFORMANCE ==="
        
        # Create configuration directory
        $configDir = "$env:ProgramData\BlueStacks_nxt"
        if (!(Test-Path $configDir)) {
            New-Item -ItemType Directory -Path $configDir -Force
        }
        
        # Write configuration to avoid graphics compatibility issues
        $config = @"
bst.instance.Nougat64.status=1
bst.instance.Nougat64.adb_port=5555
bst.feature.rooting=0
bst.instance.Nougat64.cpu_count=4
bst.instance.Nougat64.memory=3072
bst.instance.Nougat64.enable_vulkan=0
bst.instance.Nougat64.graphics_renderer=1
bst.instance.Nougat64.fastboot=1
bst.instance.Nougat64.low_memory_mode=1
bst.feature.auto_start=0
bst.instance.Nougat64.enable_dedicated_graphics=0
"@
        
        $config | Out-File -FilePath "$configDir\bluestacks.conf" -Encoding ASCII
        echo "BlueStacks performance configuration applied"

    # Step 6: Configure RDP
    - name: ğŸ” Configure RDP
      run: |
        echo "=== CONFIGURING RDP ==="
        
        # Enable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0 -Force
        
        # Configure firewall
        netsh advfirewall firewall add rule name="RDP-razzdevs" dir=in action=allow protocol=TCP localport=3389 2>&1 | Out-Null
        
        # Start service
        Set-Service -Name "TermService" -StartupType "Automatic"
        Start-Service -Name "TermService" -ErrorAction SilentlyContinue
        
        echo "RDP configured on port 3389"

    # Step 7: Create User Account
    - name: ğŸ‘¤ Create User Account
      run: |
        echo "=== CREATING USER ACCOUNT ==="
        
        # Remove existing user if any
        Remove-LocalUser -Name "razzdevs" -ErrorAction SilentlyContinue
        
        # Create user with simple password
        $SecurePassword = ConvertTo-SecureString "RazzDevs@2024!" -AsPlainText -Force
        New-LocalUser -Name "razzdevs" -Password $SecurePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "razzdevs"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "razzdevs"
        Enable-LocalUser -Name "razzdevs"
        
        echo "User 'razzdevs' created with password 'RazzDevs@2024!'"

    # Step 8: Setup Tailscale Network
    - name: ğŸŒ Setup Tailscale Network
      env:
        TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        echo "=== SETUP TAILSCALE NETWORK ==="
        
        if (-not $env:TAILSCALE_AUTH_KEY) {
            echo "TAILSCALE_AUTH_KEY not found in secrets"
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
            exit 0
        }
        
        try {
            # Install Tailscale
            $msiPath = "$env:TEMP\tailscale.msi"
            (New-Object System.Net.WebClient).DownloadFile("https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi", $msiPath)
            Start-Process msiexec.exe -ArgumentList "/i", "$msiPath", "/quiet", "/norestart" -Wait
            Remove-Item $msiPath -Force
            
            # Connect to Tailscale
            Start-Sleep -Seconds 5
            & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=razzdevs-gaming-$env:GITHUB_RUN_ID
            
            # Get IP address
            Start-Sleep -Seconds 3
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($ip) {
                echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            } else {
                echo "TAILSCALE_IP=razzdevs-gaming-$env:GITHUB_RUN_ID.tailscale.net" >> $env:GITHUB_ENV
            }
            echo "Tailscale connected successfully"
        } catch {
            echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
            echo "Tailscale setup skipped"
        }

    # Step 9: Performance Optimization
    - name: âš¡ Performance Optimization
      run: |
        echo "=== PERFORMANCE OPTIMIZATION ==="
        
        # Set high performance power plan
        powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # Optimize visual effects
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v "VisualFXSetting" /t REG_DWORD /d 2 /f
        
        # Re-enable Windows Defender
        Set-MpPreference -DisableRealtimeMonitoring $false
        Set-MpPreference -DisableBehaviorMonitoring $false
        
        echo "Performance optimizations applied"

    # Step 10: Display Connection Information
    - name: ğŸ“Š Display Connection Information
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        $startTime = Get-Date
        switch ($duration) {
            "1h" { $endTime = $startTime.AddHours(1); $displayTime = "1 hour" }
            "3h" { $endTime = $startTime.AddHours(3); $displayTime = "3 hours" }
            "5h40m" { $endTime = $startTime.AddHours(5).AddMinutes(40); $displayTime = "5 hours 40 minutes" }
        }
        
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           RAZZDEVS GAMING READY             â•‘"
        echo "â•‘     Windows + BlueStacks 5 Nougat           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ”— RDP CONNECTION INFO:"
        echo "   IP Address: $env:TAILSCALE_IP"
        echo "   Username: razzdevs"
        echo "   Password: RazzDevs@2024!"
        echo "   Port: 3389"
        echo ""
        echo "ğŸ® BLUESTACKS SETUP:"
        echo "   âœ… BlueStacks 5 Nougat installed"
        echo "   âœ… Graphics compatibility fixes applied"
        echo "   âœ… Desktop shortcut created"
        echo "   âœ… 4 CPU cores allocated"
        echo "   âœ… 3GB RAM allocated"
        echo ""
        echo "âš ï¸  IMPORTANT NOTES:"
        echo "   1. First BlueStacks boot takes 2-3 minutes"
        echo "   2. Use 'BlueStacks 5 Nougat' shortcut on desktop"
        echo "   3. Graphics compatibility already fixed"
        echo "   4. No more 'Pie not supported' error"
        echo ""
        echo "â±ï¸  SESSION DURATION: $displayTime"
        echo "   Started: $($startTime.ToString('HH:mm:ss'))"
        echo "   Ends: $($endTime.ToString('HH:mm:ss'))"
        echo ""
        echo "âœ… READY FOR GAMING! Connect via RDP to start."
        echo ""

    # Step 11: Maintain Session
    - name: â³ Maintain Session
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        switch ($duration) {
            "1h" { $minutes = 60 }
            "3h" { $minutes = 180 }
            "5h40m" { $minutes = 340 }
        }
        
        echo "Gaming session active for $minutes minutes..."
        $endTime = (Get-Date).AddMinutes($minutes)
        
        do {
            $remaining = $endTime - (Get-Date)
            if ($remaining.TotalSeconds -le 0) { break }
            
            $hours = [math]::Floor($remaining.TotalHours)
            $mins = [math]::Floor($remaining.TotalMinutes % 60)
            $secs = [math]::Floor($remaining.TotalSeconds % 60)
            
            Write-Host "â° Time remaining: $($hours.ToString('00')):$($mins.ToString('00')):$($secs.ToString('00'))" -NoNewline
            Start-Sleep -Seconds 1
            Write-Host "`r" -NoNewline
            
        } while ($remaining.TotalSeconds -gt 0)
        
        echo ""
        echo "Session completed successfully"

    # Step 12: Cleanup
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "=== CLEANUP ==="
        
        # Disable RDP
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 1 -Force
        
        # Disconnect Tailscale
        $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
        if (Test-Path $tailscalePath) {
            & $tailscalePath down -ErrorAction SilentlyContinue
        }
        
        # Stop BlueStacks if running
        Get-Process -Name "HD-Player" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
        
        echo "Cleanup completed"
